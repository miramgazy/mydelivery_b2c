# Схема работы функционала загрузки типов оплаты

## Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                      Django Admin Panel                         │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  Типы оплаты (PaymentType List)                        │    │
│  │                                                         │    │
│  │  [Загрузить типы оплаты из iiko] ← Кнопка             │    │
│  └────────────────────────────────────────────────────────┘    │
│                           │                                      │
│                           ▼                                      │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  Форма выбора организации                              │    │
│  │                                                         │    │
│  │  Организация: [Выберите организацию ▼]                │    │
│  │                                                         │    │
│  │  [Загрузить типы оплаты]  [Отмена]                    │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PaymentTypeAdmin                              │
│                                                                  │
│  sync_payment_types_view(request)                               │
│    │                                                             │
│    ├─ Получает organization_id из POST                         │
│    ├─ Проверяет наличие api_key и iiko_organization_id         │
│    └─ Вызывает IikoClient и MenuSyncService                    │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      IikoClient                                  │
│                                                                  │
│  get_payment_types([organization_id])                           │
│    │                                                             │
│    ├─ Аутентификация (получение токена)                        │
│    └─ POST /api/1/payment_types                                │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    iiko Cloud API                                │
│                                                                  │
│  POST https://api-ru.iiko.services/api/1/payment_types          │
│                                                                  │
│  Request:                                                        │
│  {                                                               │
│    "organizationIds": ["<uuid>"]                                │
│  }                                                               │
│                                                                  │
│  Response:                                                       │
│  {                                                               │
│    "paymentTypes": [                                            │
│      {                                                           │
│        "id": "<uuid>",                                          │
│        "name": "Наличные",                                      │
│        "paymentTypeKind": "Cash",                               │
│        "isDeleted": false                                       │
│      }                                                           │
│    ]                                                             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   MenuSyncService                                │
│                                                                  │
│  sync_payment_types(organization, data)                         │
│    │                                                             │
│    ├─ Извлекает paymentTypes из response                       │
│    ├─ Фильтрует удаленные (isDeleted: true)                   │
│    ├─ Для каждого типа оплаты:                                 │
│    │   ├─ Проверяет существование по payment_id                │
│    │   ├─ Обновляет существующий ИЛИ                           │
│    │   └─ Создает новый PaymentType                            │
│    └─ Возвращает список синхронизированных объектов            │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Database (PostgreSQL)                         │
│                                                                  │
│  payment_types table:                                           │
│  ┌──────────────┬──────────────┬──────────────┬──────────┐    │
│  │ payment_id   │ payment_name │ payment_type │ org_id   │    │
│  ├──────────────┼──────────────┼──────────────┼──────────┤    │
│  │ uuid-1       │ Наличные     │ Cash         │ org-1    │    │
│  │ uuid-2       │ Карта        │ Card         │ org-1    │    │
│  │ uuid-3       │ Онлайн       │ External     │ org-1    │    │
│  └──────────────┴──────────────┴──────────────┴──────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## Последовательность действий

1. **Пользователь** открывает список типов оплаты в админке
2. **Пользователь** нажимает кнопку "Загрузить типы оплаты из iiko"
3. **Система** показывает форму выбора организации
4. **Пользователь** выбирает организацию и нажимает "Загрузить"
5. **PaymentTypeAdmin** получает запрос и валидирует данные
6. **IikoClient** аутентифицируется и делает запрос к iiko API
7. **iiko Cloud API** возвращает список типов оплаты
8. **MenuSyncService** обрабатывает данные и синхронизирует с БД
9. **Система** показывает сообщение об успехе/ошибке
10. **Пользователь** перенаправляется на список типов оплаты

## Обработка ошибок

```
┌─────────────────────────────────────────────────────────────────┐
│  Возможные ошибки:                                              │
│                                                                  │
│  1. Организация не выбрана                                      │
│     → Сообщение: "Выберите организацию"                        │
│                                                                  │
│  2. Нет API Key или iiko_organization_id                       │
│     → Сообщение: "Организация X не имеет API Key или iiko ID" │
│                                                                  │
│  3. Ошибка подключения к iiko API                              │
│     → Сообщение: "Ошибка при синхронизации: <детали>"         │
│                                                                  │
│  4. Неверный формат ответа от API                              │
│     → Сообщение: "Ошибка при синхронизации: <детали>"         │
└─────────────────────────────────────────────────────────────────┘
```

## Права доступа

- **Суперпользователь**: Видит все организации
- **Админ организации**: Видит только свою организацию
- **Обычный пользователь**: Нет доступа к админке
