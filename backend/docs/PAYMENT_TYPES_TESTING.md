# Инструкция по тестированию функционала загрузки типов оплаты

## Предварительные требования

1. ✅ Backend запущен и доступен
2. ✅ База данных настроена и доступна
3. ✅ У вас есть доступ к админ-панели Django
4. ✅ Есть хотя бы одна организация с заполненными полями:
   - `api_key` (API ключ iiko)
   - `iiko_organization_id` (ID организации в iiko)

## Шаги тестирования

### 1. Проверка доступности админки

```bash
# Откройте в браузере
http://localhost:8000/administrator/
```

Войдите с учетными данными администратора.

### 2. Переход к разделу типов оплаты

1. В левом меню найдите раздел **"Организации"**
2. Нажмите на **"Типы оплаты"**
3. Вы должны увидеть список существующих типов оплаты (если есть)

### 3. Проверка наличия кнопки

В правом верхнем углу должна быть кнопка:
```
[+] Загрузить типы оплаты из iiko
```

### 4. Тестирование загрузки

1. Нажмите кнопку **"Загрузить типы оплаты из iiko"**
2. Вы должны увидеть форму с выпадающим списком организаций
3. Выберите организацию из списка
4. Нажмите **"Загрузить типы оплаты"**

### 5. Проверка результата

#### Успешная загрузка
Вы должны увидеть зеленое сообщение:
```
Успешно синхронизировано X типов оплаты для [Название организации]
```

После этого вы будете перенаправлены на список типов оплаты, где должны появиться новые записи.

#### Ошибка
Если что-то пошло не так, вы увидите красное сообщение с описанием ошибки.

### 6. Проверка данных в базе

Проверьте, что типы оплаты появились в списке:

1. Каждая запись должна содержать:
   - **Название** (например, "Наличные", "Карта")
   - **Тип оплаты** (например, "Cash", "Card", "External")
   - **Организация** (выбранная организация)
   - **Активен** (галочка должна быть установлена)

### 7. Проверка повторной загрузки

1. Повторите шаги 4-5
2. Убедитесь, что:
   - Существующие типы оплаты обновились
   - Не создались дубликаты
   - Количество записей соответствует ожидаемому

## Тестовые сценарии

### Сценарий 1: Загрузка для организации без API ключа

**Шаги:**
1. Создайте организацию без `api_key` или `iiko_organization_id`
2. Попробуйте загрузить типы оплаты для этой организации

**Ожидаемый результат:**
```
Организация [Название] не имеет API Key или iiko ID
```

### Сценарий 2: Загрузка для неактивной организации

**Шаги:**
1. Деактивируйте организацию (`is_active = False`)
2. Попробуйте найти её в списке организаций

**Ожидаемый результат:**
Организация не должна отображаться в выпадающем списке.

### Сценарий 3: Загрузка для нескольких организаций

**Шаги:**
1. Загрузите типы оплаты для организации A
2. Загрузите типы оплаты для организации B

**Ожидаемый результат:**
Каждая организация должна иметь свои типы оплаты.

## Проверка логов

Для отладки можно проверить логи:

```bash
# Логи backend
docker-compose logs -f backend

# Или если backend запущен локально
tail -f logs/backend.log
```

Ищите строки с:
```
IIKO API REQUEST: https://api-ru.iiko.services/api/1/payment_types
IIKO API RESPONSE: {...}
```

## Проверка через Django Shell

```bash
# Войдите в Django shell
docker-compose exec backend python manage.py shell

# Проверьте типы оплаты
from apps.organizations.models import PaymentType, Organization

# Получите организацию
org = Organization.objects.first()

# Получите типы оплаты для организации
payment_types = PaymentType.objects.filter(organization=org)
for pt in payment_types:
    print(f"{pt.payment_name} - {pt.payment_type}")
```

## Проверка через API (опционально)

Если у вас есть API endpoint для типов оплаты:

```bash
# GET запрос к API
curl -X GET http://localhost:8000/api/organizations/payment-types/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Возможные проблемы и решения

### Проблема 1: Кнопка не отображается

**Решение:**
1. Проверьте, что файл `paymenttype_changelist.html` создан
2. Перезапустите backend
3. Очистите кэш браузера

### Проблема 2: Ошибка 404 при нажатии на кнопку

**Решение:**
1. Проверьте, что URL зарегистрирован в `get_urls()`
2. Проверьте имя URL: `admin:paymenttype_sync_iiko`

### Проблема 3: Ошибка подключения к iiko API

**Решение:**
1. Проверьте интернет-соединение
2. Проверьте правильность API ключа
3. Проверьте, что iiko Cloud API доступен

### Проблема 4: Типы оплаты не создаются

**Решение:**
1. Проверьте логи на наличие ошибок
2. Проверьте формат ответа от iiko API
3. Убедитесь, что `isDeleted: false` для типов оплаты

## Чек-лист тестирования

- [ ] Кнопка отображается в списке типов оплаты
- [ ] Форма выбора организации открывается
- [ ] Список организаций заполнен корректно
- [ ] Загрузка типов оплаты работает
- [ ] Сообщение об успехе отображается
- [ ] Типы оплаты появляются в списке
- [ ] Повторная загрузка обновляет данные
- [ ] Обработка ошибок работает корректно
- [ ] Права доступа работают (суперпользователь vs админ организации)
- [ ] Логи содержат информацию о запросах

## Результаты тестирования

Заполните после тестирования:

- **Дата тестирования:** ___________
- **Тестировщик:** ___________
- **Версия:** ___________
- **Результат:** ☐ Успешно ☐ С ошибками ☐ Провалено
- **Комментарии:** ___________
